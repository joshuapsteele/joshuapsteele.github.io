{{- /*
  Amazon Purchases Table Shortcode

  Usage:
    {{< amazon-purchases-table >}}

  Params:
    - showCategory: "true" or "false" (default: true)
    - showNotes: "true" or "false" (default: true)
*/ -}}

{{- $showCategory := ne (.Get "showCategory") "false" -}}
{{- $showNotes := ne (.Get "showNotes") "false" -}}

{{- $resource := resources.Get "amazon/amazon_purchases_public.csv" -}}
{{- if not $resource -}}
  <p>Public purchases data not found. Run <code>python scripts/amazon/build_public.py</code> to generate data.</p>
{{- else -}}
  {{- $data := $resource | transform.Unmarshal -}}
  {{- $items := slice -}}

  {{- if gt (len $data) 0 -}}
    {{- if reflect.IsMap (index $data 0) -}}
      {{- $items = $data -}}
    {{- else -}}
      {{- $header := index $data 0 -}}
      {{- $colIndex := dict -}}
      {{- range $i, $name := $header -}}
        {{- $colIndex = merge $colIndex (dict $name $i) -}}
      {{- end -}}

      {{- range $row := after 1 $data -}}
        {{- $item := dict
          "product_name" (index $row (index $colIndex "product_name"))
          "affiliate_url" (index $row (index $colIndex "affiliate_url"))
          "category" (index $row (index $colIndex "category"))
          "notes" (index $row (index $colIndex "notes"))
        -}}
        {{- $items = $items | append $item -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if lt (len $items) 1 -}}
    <p>No purchases found.</p>
  {{- else -}}
  <div class="amazon-purchases" data-amazon-purchases>
    <div class="amazon-purchases-controls">
      <label class="amazon-purchases-search-label" for="amazon-purchases-search">Search</label>
      <input
        id="amazon-purchases-search"
        class="amazon-purchases-search"
        data-amazon-purchases-search
        type="search"
        placeholder="Search products, categories, notes..."
        autocomplete="off"
      />
      <span class="amazon-purchases-count" data-amazon-purchases-count></span>
    </div>
    <table class="amazon-purchases-table">
        <thead>
          <tr>
            <th>Product</th>
            {{- if $showCategory -}}
            <th>Category</th>
            {{- end -}}
            {{- if $showNotes -}}
            <th>Notes</th>
            {{- end -}}
          </tr>
        </thead>
        <tbody>
          {{- range sort $items "product_name" -}}
          <tr>
            <td>
              {{- $name := .product_name -}}
              {{- $url := .affiliate_url -}}
              {{- if $url -}}
                <a href="{{ $url }}" rel="sponsored nofollow" target="_blank">{{ $name }}</a>
              {{- else -}}
                {{ $name }}
              {{- end -}}
            </td>
            {{- if $showCategory -}}
            <td>{{ .category }}</td>
            {{- end -}}
            {{- if $showNotes -}}
            <td>{{ .notes }}</td>
            {{- end -}}
          </tr>
        {{- end -}}
      </tbody>
    </table>
  </div>
  <script src="/js/amazon-purchases.js" defer></script>
  {{- end -}}
{{- end -}}
