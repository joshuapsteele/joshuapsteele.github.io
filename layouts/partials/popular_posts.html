{{- /*
  Popular Posts Partial

  Displays a list of popular posts based on Tinylytics analytics data.
  Reads from data/popular.json which should be generated by fetch_popular_posts.py

  Usage:
    {{ partial "popular_posts.html" (dict "context" . "limit" 5 "showHits" true "heading" "Popular Posts") }}

  Parameters:
    - context: The page context (usually .)
    - limit: Maximum number of posts to show (default: 5)
    - showHits: Whether to show hit counts (default: false)
    - heading: Section heading text (default: "Popular Posts")
    - currentPath: Path to exclude from list (optional, useful on single pages)
*/ -}}

{{- $limit := .limit | default 5 -}}
{{- $showHits := .showHits | default false -}}
{{- $heading := .heading | default "Popular Posts" -}}
{{- $currentPath := .currentPath | default "" -}}
{{- $context := .context -}}

{{- with site.Data.popular -}}
  {{- if .posts -}}
    {{- $posts := slice -}}
    {{- range .posts -}}
      {{- if ne .path $currentPath -}}
        {{- $posts = $posts | append . -}}
      {{- end -}}
    {{- end -}}
    {{- $posts = first $limit $posts -}}

    {{- if $posts -}}
    <div class="popular-posts">
      <h3 class="popular-posts-heading">{{ $heading }}</h3>
      <p class="popular-posts-period">Top posts from the past {{ site.Data.popular.period_days }} days</p>
      <ul class="popular-posts-list">
        {{- range $posts -}}
          {{- $path := .path -}}
          {{- $hits := .hits -}}
          {{- /* Try to find the actual page to get its title */ -}}
          {{- $page := site.GetPage $path -}}
          {{- if $page -}}
            <li class="popular-post-item">
              <a href="{{ $page.Permalink }}" class="popular-post-link">
                {{ $page.Title }}
              </a>
              {{- if $showHits -}}
              <span class="popular-post-hits">({{ $hits }} views)</span>
              {{- end -}}
            </li>
          {{- else -}}
            {{- /* Fallback: try common content locations */ -}}
            {{- $blogPath := printf "/blog%s" $path -}}
            {{- $page = site.GetPage $blogPath -}}
            {{- if not $page -}}
              {{- $page = site.GetPage (strings.TrimSuffix "/" $path) -}}
            {{- end -}}
            {{- if $page -}}
            <li class="popular-post-item">
              <a href="{{ $page.Permalink }}" class="popular-post-link">
                {{ $page.Title }}
              </a>
              {{- if $showHits -}}
              <span class="popular-post-hits">({{ $hits }} views)</span>
              {{- end -}}
            </li>
            {{- else -}}
            {{- /* Last fallback: show path as link text */ -}}
            <li class="popular-post-item">
              <a href="{{ $path }}" class="popular-post-link">
                {{ $path | replaceRE "^/|/$" "" | replaceRE "-" " " | title }}
              </a>
              {{- if $showHits -}}
              <span class="popular-post-hits">({{ $hits }} views)</span>
              {{- end -}}
            </li>
            {{- end -}}
          {{- end -}}
        {{- end -}}
      </ul>
      <p class="popular-posts-link">
        <a href="/popular/">View all popular posts</a>
      </p>
    </div>
    {{- end -}}
  {{- end -}}
{{- end -}}
